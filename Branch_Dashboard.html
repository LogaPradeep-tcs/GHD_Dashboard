<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GHD Ticket Dashboard (India)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: darkblue; }
    #clearBtn, #copyAllBtn { margin-left: 10px; }
    td.details-control {
      background: url('https://www.datatables.net/examples/resources/details_open.png') no-repeat center center;
      cursor: pointer;
      width: 20px;
    }
    tr.shown td.details-control {
      background: url('https://www.datatables.net/examples/resources/details_close.png') no-repeat center center;
    }
    td.user-details-control {
      background: url('https://www.datatables.net/examples/resources/details_open.png') no-repeat center center;
      cursor: pointer;
      width: 20px;
    }
    tr.shown-user td.user-details-control {
      background: url('https://www.datatables.net/examples/resources/details_close.png') no-repeat center center;
    }
    table.dataTable tbody td { vertical-align: middle; }
    #ticketTable tbody tr:hover { background-color: #f0f8ff; }
    .copy-btn {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 10px;
      cursor: pointer;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .copy-btn:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <h2>GHD Ticket Dashboard (India)</h2>

  <input type="file" id="upload" accept=".xlsx" />
  <button id="clearBtn">Clear</button>
  <button id="copyAllBtn" style="display:none;">Copy All Data</button>

  <h3>Branch Ticket Summary</h3>
  <table id="ticketTable" class="display" width="100%">
    <thead>
      <tr>
        <th></th>
        <th>Branch</th>
        <th>Total Pending Tickets</th>
        <th style="display:none">Users</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let tableData = {};
    let dataTable;
    let expandedBranchRow = null;

    function parseExcelDate(value) {
      if (!value) return null;
      if (typeof value === 'number') {
        const utc_days = value - 25569;
        const utc_value = utc_days * 86400 * 1000;
        return new Date(utc_value);
      } else {
        return new Date(value);
      }
    }

    function formatBranch(branchData, branchName) {
      let html = `<button class="copy-btn" onclick="copyBranchData('${branchName}')">Copy Branch Data</button>`;
      html += '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
      html += '<tr><th></th><th>Associate Name</th><th>Pending Tickets</th></tr>';

      const users = Object.entries(branchData.users).sort((a,b) => b[1].count - a[1].count);
      users.forEach(([user, data]) => {
        html += `<tr>
                  <td class="user-details-control"></td>
                  <td>${user}</td>
                  <td>${data.count}</td>
                 </tr>`;
      });
      html += '</table>';
      return html;
    }

    function formatUser(userData, userName) {
      let html = `<button class="copy-btn" onclick="copyUserData('${userName.replace(/'/g, "\\'")}')">Copy User Data</button>`;
      html += '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:70px;">';
      html += '<tr><th>Ticket Number</th><th>Aging Days</th></tr>';

      const now = new Date();
      userData.tickets.forEach(ticketObj => {
        const ticketNum = ticketObj.number;
        const loggedDate = parseExcelDate(ticketObj.loggedDate);
        let ageDays = 'N/A';
        if (loggedDate && !isNaN(loggedDate)) {
          ageDays = ((now - loggedDate)/(1000*60*60*24)).toFixed(2);
        }
        html += `<tr><td>${ticketNum}</td><td>${ageDays}</td></tr>`;
      });

      html += '</table>';
      return html;
    }

    document.getElementById('upload').addEventListener('change', handleFile);
    document.getElementById('clearBtn').addEventListener('click', () => location.reload());

    document.getElementById('copyAllBtn').addEventListener('click', () => {
      const rows = $('#ticketTable').DataTable().rows({ search: 'applied' }).data();
      let text = "Branch\tTotal Pending Tickets\n";
      for (let i = 0; i < rows.length; i++) {
        text += `${rows[i][1]}\t${rows[i][2]}\n`;
      }
      navigator.clipboard.writeText(text);
      alert("Branch data copied!");
    });

    function handleFile(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        tableData = {};
        json.forEach(row => {
          if (row.Country === "India") {
            const branch = row.Branch;
            const user = row["SP Username"];
            const ticketNum = row["Ticket Number"];
            const loggedDate = row["Logged Date"];

            if (!tableData[branch]) tableData[branch] = { total: 0, users: {} };
            tableData[branch].total += ticketNum ? 1 : 0;

            if (!tableData[branch].users[user]) {
              tableData[branch].users[user] = { count: 0, tickets: [] };
            }
            tableData[branch].users[user].count += ticketNum ? 1 : 0;
            if (ticketNum) {
              tableData[branch].users[user].tickets.push({ number: ticketNum, loggedDate: loggedDate });
            }
          }
        });

        document.getElementById('copyAllBtn').style.display = "inline-block";
        renderTable();
      };
      reader.readAsArrayBuffer(file);
    }

    function renderTable() {
      if (dataTable) dataTable.destroy();
      const tableBody = document.querySelector("#ticketTable tbody");
      tableBody.innerHTML = "";

      Object.keys(tableData).forEach(branch => {
        const hiddenUsers = Object.keys(tableData[branch].users).join('|');
        const row = `<tr>
          <td class="details-control"></td>
          <td>${branch}</td>
          <td>${tableData[branch].total}</td>
          <td style="display:none">${hiddenUsers}</td>
        </tr>`;
        tableBody.innerHTML += row;
      });

      dataTable = $('#ticketTable').DataTable({ 
        order: [[2, "desc"]], 
        deferRender: true,
        paging: false,
        info: false,
        searching: true
      });

      // Global search including hidden user names
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        const searchTerm = $('.dataTables_filter input').val().toLowerCase();
        if (!searchTerm) return true;

        const branchName = data[1].toLowerCase();
        const users = data[3].toLowerCase(); // hidden user list
        return branchName.includes(searchTerm) || users.includes(searchTerm);
      });

      $('#ticketTable_filter input').off('keyup').on('keyup', function() {
        dataTable.draw();
      });

      // Branch expand/collapse
      $('#ticketTable tbody').off('click', 'td.details-control').on('click', 'td.details-control', function () {
        const tr = $(this).closest('tr');
        const row = dataTable.row(tr);
        const branchName = row.data()[1];

        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass('shown');
          expandedBranchRow = null;
          return;
        }

        if (expandedBranchRow && expandedBranchRow[0] !== tr[0]) {
          expandedBranchRow.child.hide();
          expandedBranchRow.nodes().to$().removeClass('shown');
        }

        row.child(formatBranch(tableData[branchName], branchName)).show();
        tr.addClass('shown');
        expandedBranchRow = row;

        // User expand/collapse
        tr.next('tr').find('td.user-details-control').off('click').on('click', function () {
          const userRow = $(this).closest('tr');

          $('#ticketTable tbody tr.shown-user').each(function() {
            if ($(this)[0] !== userRow[0]) {
              $(this).next('tr').remove();
              $(this).removeClass('shown-user');
            }
          });

          const userName = userRow.find('td:nth-child(2)').text();
          const userData = tableData[branchName].users[userName];

          if (userRow.hasClass('shown-user')) {
            userRow.next('tr').remove();
            userRow.removeClass('shown-user');
          } else {
            const ticketHtml = '<tr><td colspan="3">'+formatUser(userData, userName)+'</td></tr>';
            userRow.after(ticketHtml);
            userRow.addClass('shown-user');
          }
        });
      });
    }

    function copyBranchData(branchName) {
      let text = `Branch: ${branchName}\nAssociate Name\tPending Tickets\n`;
      const users = Object.entries(tableData[branchName].users).sort((a,b) => b[1].count - a[1].count);
      users.forEach(([user, data]) => {
        text += `${user}\t${data.count}\n`;
      });
      navigator.clipboard.writeText(text);
      alert(`Branch "${branchName}" data copied!`);
    }

    function copyUserData(userName) {
      for (const branch in tableData) {
        if (tableData[branch].users[userName]) {
          let text = `User: ${userName}\nTicket Number\tAging in days\n`;
          const now = new Date();
          tableData[branch].users[userName].tickets.forEach(ticket => {
            const loggedDate = parseExcelDate(ticket.loggedDate);
            let ageDays = 'N/A';
            if (loggedDate && !isNaN(loggedDate)) {
              ageDays = ((now - loggedDate)/(1000*60*60*24)).toFixed(2);
            }
            text += `${ticket.number}\t${ageDays}\n`;
          });
          navigator.clipboard.writeText(text);
          alert(`Tickets for ${userName} copied!`);
          break;
        }
      }
    }
  </script>
</body>
</html>

